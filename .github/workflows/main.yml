- name: Deploy to CentOS Stream 8 Server
  run: |
    echo "${{ secrets.SERVER_SSH_KEY }}" > private_key.pem
    chmod 600 private_key.pem
    
    # Test SSH connection first
    echo "Testing SSH connection..."
    ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'SSH connection successful!'"
    
    # Copy files
    echo "Copying database file..."
    scp -o StrictHostKeyChecking=no -i private_key.pem database.sql ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/${{ secrets.SERVER_USER }}/app/database.sql
    
    # Deploy
    echo "Starting deployment..."
    ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
    set -euo pipefail
    
    echo "Deploying on $(hostname)..."
    
    # Your deployment commands here
    docker login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}"
    docker network create app_network || true
    
    # Stop old containers
    docker rm -f php-nginx php-web mysql-db || true
    
    # Pull and run new containers
    docker pull ${{ secrets.DOCKER_USERNAME }}/php-web
    docker pull ${{ secrets.DOCKER_USERNAME }}/php-nginx
    
    # Run MySQL
    docker run -d --name mysql-db --network app_network \
      -v db_data:/var/lib/mysql \
      -v /home/${{ secrets.SERVER_USER }}/app/database.sql:/docker-entrypoint-initdb.d/database.sql \
      -e MYSQL_ROOT_PASSWORD=pass@321 \
      -e MYSQL_DATABASE=student_enrollment \
      -p 3306:3306 \
      --restart unless-stopped \
      mysql:8.0
    
    sleep 30
    
    # Run PHP
    docker run -d --name php-web --network app_network \
      -e DB_HOST=mysql-db -e DB_USER=root -e DB_PASSWORD=pass@321 -e DB_NAME=student_enrollment \
      --restart unless-stopped \
      ${{ secrets.DOCKER_USERNAME }}/php-web
    
    # Run Nginx
    docker run -d --name php-nginx --network app_network \
      -p 80:80 \
      --restart unless-stopped \
      ${{ secrets.DOCKER_USERNAME }}/php-nginx
    
    echo "Deployment completed successfully!"
    EOF
